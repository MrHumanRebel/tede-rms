{% extends "assets/template.twig" %}

{% block content %}
<div class="row">
    <div class="col-12">
        {% if searchResults.SEARCH.PROJECT_ID and searchResults.SEARCH.PROJECT_REFERER and searchResults.SEARCH.PROJECT_ID == searchResults.SEARCH.PROJECT_REFERER %}
            {% for project in searchOptions.projects %}
                {% if searchResults.SEARCH.PROJECT_ID == project.projects_id %}
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-pills">
                                <li class="nav-item"><a class="nav-link" href="{{CONFIG.ROOTURL}}/project/?id={{project.projects_id}}#details-view"><i class="fas fa-arrow-left"></i> Back to <span style="font-weight:bold;">{{project.projects_name}}</span></a></li>
                            </ul>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
        <form method="get" action="{{CONFIG.ROOTURL}}/assets.php" id="assetSearchForm">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Eszközök</h3>
                    <div class="card-tools">
                        <a href="{{ CONFIG.ROOTURL }}/api/assets/export.php?xlsx" class="btn btn-tool" title="Excel Export"><i class="fas fa-file-excel"></i></a>
                        <a href="{{ CONFIG.ROOTURL }}/api/assets/export.php?csv" class="btn btn-tool" title="CSV Export"><i class="fas fa-file-csv"></i></a>
                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="form-group">
                                <label>Kulcsszó</label>
                                <select class="form-control select2bs4" multiple="multiple" name="keyword[]">
                                    {% for term in searchResults.SEARCH.TERMS.KEYWORDS %}
                                        <option value="{{ term }}" selected>{{ term }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Több kulcsszót vesszővel válasszon el</small>
                            </div>
                            <div class="form-group">
                                <label>Címke</label>
                                <select class="form-control select2bs4" multiple="multiple" name="tags[]">
                                    {% for tag in searchResults.SEARCH.TERMS.TAGS %}
                                        <option value="{{ tag }}" selected>{{ tag }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Gyártó</label>
                                <select class="form-control select2bs4" multiple name="manufacturer[]">
                                    {% for manufacturer in searchResults.SEARCH['SELECTED_TERMS']['MANUFACTURER'] %}
                                        <option value="{{ manufacturer.manufacturers_id }}" selected>{{ manufacturer.manufacturers_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                        </div>
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="form-group">
                                <label>Csoport</label>
                                <select class="form-control select2bs4" name="group[]" multiple>
                                    {% for group in searchResults.SEARCH['SELECTED_TERMS']['GROUPS'] %}
                                        <option value="{{ group.assetGroups_id }}" selected>{{ group.assetGroups_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Kategória</label>
                                <select class="form-control select2bs4" multiple name="category[]">
                                    {% for category in searchResults.SEARCH['SELECTED_TERMS']['CATEGORY'] %}
                                        <option value="{{ category.assetCategories_id }}" selected>{{ category.assetCategoriesGroups_name }} - {{ category.assetCategories_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Vállalkozás</label>
                                <select class="form-control select2 select2bs4" name="instance_id">
                                    {% for instance in USERDATA.instances %}
                                        <option {{ searchResults.SEARCH.INSTANCE_ID == instance.instances_id ? 'selected' : '' }}  value="{{instance.instances_id}}">{{instance.instances_name}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4">
                            {% if "PROJECTS:PROJECT_ASSETS:CREATE:ASSIGN_AND_UNASSIGN"|instancePermissions %}
                                <div class="form-group">
                                    <label>Projekt, amelyhez eszközöket rendelhetsz</label>
                                    <select class="form-control select2 select2bs4" name="project">
                                        <option value="">Nincs kiválasztott projekt</option>
                                        {% for project in searchOptions.projects %}
                                            <option {{ searchResults.SEARCH.PROJECT_ID == project.projects_id ? 'selected' : '' }}  value="{{ project.projects_id }}">{{ project.projects_name }}{{ project.clients_name ? " | " ~ project.clients_name : "" }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                {% if searchResults.SEARCH.PROJECT_ID == searchResults.SEARCH.PROJECT_REFERER %}
                                    <input type="hidden" name="project_referer" value="{{ searchResults.SEARCH.PROJECT_REFERER }}">
                                {% endif %}
                            {% else %}
                                <div class="form-group">
                                    <label>Elérhetőség megjelenítése az alábbi időpontok között</label>
                                    <input type="text" class="form-control" name="dates" value="{{ searchResults.SEARCH.TERMS['DATE-START'] ? searchResults.SEARCH.TERMS['DATE-START'] ~ " - " ~ searchResults.SEARCH.TERMS['DATE-END'] }}" />
                                </div>
                            {% endif %}
                            <div class="form-group">
                                <label>Eredmények száma oldalanként</label>
                                <select class="form-control select2 select2bs4" name="resultsperpage">
                                    <option {{ searchResults.SEARCH.PAGE_LIMIT == 10 ? 'selected' : '' }}>10</option>
                                    <option {{ searchResults.SEARCH.PAGE_LIMIT == 20 ? 'selected' : '' }}>20</option>
                                    <option {{ searchResults.SEARCH.PAGE_LIMIT == 50 ? 'selected' : '' }}>50</option>
                                    <option {{ searchResults.SEARCH.PAGE_LIMIT == 100 ? 'selected' : '' }}>100</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Rendezés</label>
                                <select class="form-control select2 select2bs4" name="sort">
                                    <option {{ searchResults.SEARCH.TERMS.SORT == "price-a" ? 'selected' : '' }}  value="price-a">Heti ár (alacsony-magas)</option>
                                    <option {{ searchResults.SEARCH.TERMS.SORT == "price-d" ? 'selected' : '' }}  value="price-d">Heti ár (magas-alacsony)</option>
                                    <option {{ searchResults.SEARCH.TERMS.SORT == "value-a" ? 'selected' : '' }}  value="value-a">Érték (alacsony-magas)</option>
                                    <option {{ searchResults.SEARCH.TERMS.SORT == "value-d" ? 'selected' : '' }}  value="value-d">Érték (magas-alacsony)</option>
                                    <option {{ searchResults.SEARCH.TERMS.SORT == "alphabet-a" ? 'selected' : '' }}  value="alphabet-a">ABC sorrend (A-Z)</option>
                                    <option {{ searchResults.SEARCH.TERMS.SORT == "alphabet-d" ? 'selected' : '' }}  value="alphabet-d">ABC sorrend (Z-A)</option>
                                    <option {{ searchResults.SEARCH.TERMS.SORT == "mass-a" ? 'selected' : '' }}  value="mass-a">Tömeg (alacsony-magas)</option>
                                    <option {{ searchResults.SEARCH.TERMS.SORT == "mass-d" ? 'selected' : '' }}  value="mass-d">Tömeg (magas-alacsony)</option>
                                    <option {{ searchResults.SEARCH.TERMS.SORT == "date-d" ? 'selected' : '' }}  value="date-d">Hozzáadás dátuma (legújabb elöl)</option>
                                    <option {{ searchResults.SEARCH.TERMS.SORT == "date-a" ? 'selected' : '' }}  value="date-a">Hozzáadás dátuma (legkorábbi elöl)</option>
                                </select>
                            </div>
                        </div>
                            <style>
                                .mb-1 {
                                    margin-left: 20px;
                                }
                            </style>
                            {# 
                            <div class="mb-1">
                                <input type="checkbox" name="showlinked" value="1" class="mr-1" {{ searchResults.SEARCH.SETTINGS.SHOWLINKED ? "checked" : "" }}>
                                <span>Az egyes eszközökhöz rendelt eszközök megjelenítése</span>
                            </div>
                            #}
                            <div class="mb-1">
                                <input type="checkbox" name="showarchived" value="1" class="mr-1" {{ searchResults.SEARCH.SETTINGS.SHOWARCHIVED ? "checked" : "" }}>
                                <span>Archivált eszközök megjelenítése</span>
                            </div>
                            <div class="mb-1">
                                <input type="checkbox" name="hideimages" value="1" class="mr-1" {{ searchResults.SEARCH.SETTINGS.HIDEIMAGES ? "checked" : "" }}>
                                <span>Eszköz képek elrejtése</span>
                            </div>
                            <div class="mb-1">
                                <input type="checkbox" name="hidenostock" value="1" class="mr-1" {{ searchResults.SEARCH.SETTINGS.HIDENOSTOCK ? "checked" : "" }}>
                                <span>Nincs elérhető készleten elrejtése</span>
                            </div>
                            <div class="mb-1">
                                <input type="checkbox" name="hidesubassets" value="1" class="mr-1" {{ searchResults.SEARCH.SETTINGS.HIDESUBASSETS ? "checked" : "" }} id="hidesubassets">
                                <span>Csak aleszközöket tartalmazók megjelenítése</span>
                            </div>
                            <div class="mb-1">
                                <input type="checkbox" name="showsubassets" value="1" class="mr-1" {{ searchResults.SEARCH.SETTINGS.SHOWSUBASSETS ? "checked" : "" }} id="showsubassets">
                                <span>Csak aleszközöket nem tartalmazók megjelenítése</span>
                            </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary btn-lg ">Keresés</button>
                    <button type="button" class="btn btn-secondary btn-lg" onclick="window.location.reload(true)">Frissítés</button>
                </div>
            </div>
        </form>
    </div>
    <div class="col-12">
        {% if searchResults.ASSETS %}
        <div class="card card-solid">
            <div class="card-header">
                <h3 class="card-title" style="margin-top: 0.4rem;">
                    {{ searchResults.PAGINATION.OFFSET > 0 ? 'A ' ~ searchResults.PAGINATION.OFFSET ~ '-' ~ (searchResults.PAGINATION.OFFSET + (searchResults.ASSETS|length)) ~ ' találatot mutatunk' : searchResults.ASSETS|length ~ ' találat' }} a(z) {{ searchResults.PAGINATION.COUNT }} eszközből
                </h3>
                <div class="card-tools pull-right">
                {% if searchResults.PAGINATION['TOTAL-PAGES'] > 1 %}
                    <ul class="pagination pagination-sm m-0">
                        {% if searchResults.PAGINATION.PAGE > 1 %}
                            <li class="page-item"><a class="page-link" href="#" data-page="{{ (searchResults.PAGINATION.PAGE -1) }}">&laquo;</a></li>
                        {% endif %}

                        {% for i in range((searchResults.PAGINATION.PAGE > 3 ? searchResults.PAGINATION.PAGE-2 : 1), (searchResults.PAGINATION['TOTAL-PAGES'] > 5 and searchResults.PAGINATION.PAGE+2 < searchResults.PAGINATION['TOTAL-PAGES'] ? searchResults.PAGINATION.PAGE+2 : searchResults.PAGINATION['TOTAL-PAGES'])) %}
                            <li class="page-item"><a class="page-link" href="#" data-page="{{ i }}">
                                    {% if searchResults.PAGINATION.PAGE == i %}
                                        <b>{{ i }}</b>
                                    {% else %}
                                        {{ i }}
                                    {% endif %}
                                </a></li>
                        {% endfor %}
                        {% if searchResults.PAGINATION.PAGE < searchResults.PAGINATION['TOTAL-PAGES'] %}
                            <li class="page-item"><a class="page-link" href="#" data-page="{{searchResults.PAGINATION.PAGE+1}}">&raquo;</a></li>
                        {% endif %}
                    </ul>
                {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row d-flex align-items-stretch">
                    {% for asset in searchResults.ASSETS %}

                        {% set stock_based_render = false %}
                        {% if asset.countAvailable <= 0 and searchResults.SEARCH.SETTINGS.HIDENOSTOCK == true %}
                            {% set stock_based_render = true %}
                        {% endif %}

                        {% set subasset_based_render = false %}
                        {% if not asset.hasSubAssets and searchResults.SEARCH.SETTINGS.HIDESUBASSETS == true %}
                            {% set subasset_based_render = true %}
                        {% elseif asset.hasSubAssets and searchResults.SEARCH.SETTINGS.SHOWSUBASSETS == true %}
                            {% set subasset_based_render = true %}
                        {% endif %}

                        {% if stock_based_render == false %}
                        {% if subasset_based_render == false %}
                            <div class="col-auto d-flex align-items-stretch" style="padding: 10px;">
                                <div class="card bg-light">
                                    <div class="card-body" style="max-width: 250px;">
                                        <h2 class="lead"><b>{{ asset.assetTypes_name }}</b></h2>
                                        {% if CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and asset.thumbnail|length > 0 and searchResults.SEARCH.SETTINGS.HIDEIMAGES != true %}
                                            <div class="{% if asset.thumbnail|length > 1 %}slick{% endif %}" style="text-align:center;height:200px;">
                                                {% for thumb in asset.thumbnail %}
                                                    <div>
                                                        <a href="{{ CONFIG.ROOTURL }}/asset.php?id={{ asset.assetTypes_id }}{{ asset.count == 1 ? '&asset=' ~ asset.tags[0]['assets_id'] : '' }}{{ SEARCH["SETTINGS"]["SHOWARCHIVED"] ? '&showArchived' : ''}}&instance={{ searchResults.SEARCH.INSTANCE_ID }}" target="_blank">
                                                        <img class="img-fluid" loading="lazy" style="max-height: 200px;"
                                                            src="{{ thumb.s3files_id|s3URL("small") }}"
                                                            fetchpriority="low" alt="{{asset.assetTypes_name}}"></a>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <p class="text-muted text-sm">{{ asset.assetTypes_description|length > 60 ? (asset.assetTypes_description|slice(0, 60) ~ '...')|nl2br : asset.assetTypes_description|nl2br  }}</p>
                                        <ul class="ml-4 mb-0 fa-ul text-muted">
                                            <li class="small"><span class="fa-li"><i class="{{ asset.assetCategories_fontAwesome }}"></i></span> {{ asset.assetCategoriesGroups_name }} - {{ asset.assetCategories_name }}</li>
                                            {% if asset.manufacturers_id != 1 %}<li class="small"><span class="fa-li"><i class="fas fa-industry"></i></span> {{ asset.manufacturers_name }}</li>{% endif %}
                                            {% if asset.count == 1 %}
                                                {# Because there's just one asset it might have a load of specific overrides so we had better show those #}
                                                {% if asset.tags[0]['assets_mass'] != 0 or asset.assetTypes_mass != 0 %}
                                                <li class="small">
                                                    <span class="fa-li"><i class="fas fa-weight"></i></span> {{ (asset.tags[0]['assets_mass'] ? asset.tags[0]['assets_mass']|number_format(2) : (asset.assetTypes_mass != "" and asset.assetTypes_mass != 0 ? asset.assetTypes_mass|mass : '?')) }}
                                                </li>
                                                {% endif %}
                                                {% if "ASSETS:ASSET_TYPES:EDIT"|instancePermissions %}
                                                <li class="small">
                                                    <span class="fa-li"><i class="fas fa-money-bill-wave"></i></span> {{ (asset.tags[0]['assets_value'] ?: asset.assetTypes_value)|money(SEARCH.INSTANCE['instances_config_currency'])|replace({',00':''}) }}<br/>
                                                    {{ (asset.tags[0]['assets_dayRate'] ?: asset.assetTypes_dayRate)|money(SEARCH.INSTANCE['instances_config_currency'])|replace({',00':''}) }}/nap<br/>
                                                    {{ (asset.tags[0]['assets_weekRate'] ?: asset.assetTypes_weekRate)|money(SEARCH.INSTANCE['instances_config_currency'])|replace({',00':''}) }}/hét
                                                </li>
                                                {% endif %}
                                                {# Írd ki az eszközök számát #}
                                                {% if searchResults.PROJECT.ID and not asset.isAssetReleased %}
                                                    <li class="small" title="Birtokolt eszközök száma"><span class="fa-li"><i class="fas fa-boxes"></i></span><strong style="font-size: larger;">A raktárban <br> {{ asset.count }} -ból {{ asset.countAvailable }} elérhető</strong></li>
                                                {% else %}
                                                    <li class="small" title="Birtokolt eszközök száma"><span class="fa-li"><i class="fas fa-boxes"></i></span><strong style="font-size: larger;">A raktárban összesen {{ asset.count }} elérhető</strong></li>
                                                {% endif %}
                                                {% if searchResults.PROJECT.ID and asset.isAssetReleased %}
                                                    <li class="small" title="Feltételesen foglalva" style="margin-top: 10px;">
                                                        <strong style="font-size: larger; color: blue; border: 2px solid blue; padding: 3px 10px; border-radius: 10px;">{{ asset.countBlocked }} Feltételesen foglalt!</strong>
                                                    </li>
                                                {% endif %}
                                                {% if searchResults.PROJECT.ID and asset.countAvailable == 0 and not asset.isAssetReleased %}
                                                    <li class="small" title="Nincs elérhető készlet" style="margin-top: 10px;">
                                                        <strong style="font-size: larger; color: red; border: 2px solid red; padding: 3px 10px; border-radius: 10px;">Nincs elérhető készlet!</strong>
                                                    </li>
                                                {% endif %}
                                                {% if asset.hasSubAssets %}
                                                    <li class="small" title="Aleszközöket tartalmaz" style="margin-top: 10px;">
                                                        <strong style="font-size: larger; color: green; border: 2px solid green; padding: 3px 10px; border-radius: 10px;">
                                                            {{ asset.countSubAssets }} Aleszközt tartalmaz!
                                                        </strong>
                                                    </li>
                                                {% endif %}
                                                {% if asset.extra_assets != 0 %}
                                                    <li class="small" title="Raktárkészleten felül" style="margin-top: 10px;">
                                                        <strong style="font-size: larger; color: red; border: 2px solid red; padding: 3px 10px; border-radius: 10px;">{{ asset.extra_assets }} Raktáron felül!</strong>
                                                    </li>
                                                {% endif %}
                                            {% else %}
                                                {% if asset.assetTypes_mass != "" and asset.assetTypes_mass != 0 %}
                                                <li class="small">
                                                    <span class="fa-li"><i class="fas fa-weight"></i></span> {{ asset.assetTypes_mass|mass }}
                                                </li>
                                                {% endif %}
                                                {% if "ASSETS:ASSET_TYPES:EDIT"|instancePermissions %}
                                                <li class="small">
                                                    <span class="fa-li"><i class="fas fa-money-bill-wave"></i></span> {{ asset.assetTypes_value|money(SEARCH.INSTANCE['instances_config_currency'])|replace({',00':''}) }}<br/>
                                                    {{ asset.assetTypes_dayRate|money(SEARCH.INSTANCE['instances_config_currency'])|replace({',00':''}) }}/nap<br/>
                                                    {{ asset.assetTypes_weekRate|money(SEARCH.INSTANCE['instances_config_currency'])|replace({',00':''}) }}/hét
                                                </li>
                                                {% endif %}
                                                {# Írd ki az eszközök számát #}
                                                {% if searchResults.PROJECT.ID and not asset.isAssetReleased %}
                                                    <li class="small" title="Birtokolt eszközök száma"><span class="fa-li"><i class="fas fa-boxes"></i></span><strong style="font-size: larger;">A raktárban <br> {{ asset.count }} -ból {{ asset.countAvailable }} elérhető</strong></li>
                                                {% else %}
                                                    <li class="small" title="Birtokolt eszközök száma"><span class="fa-li"><i class="fas fa-boxes"></i></span><strong style="font-size: larger;">A raktárban összesen {{ asset.count }} elérhető</strong></li>
                                                {% endif %}
                                                {% if searchResults.PROJECT.ID and asset.isAssetReleased %}
                                                    <li class="small" title="Feltételesen foglalva" style="margin-top: 10px;">
                                                        <strong style="font-size: larger; color: blue; border: 2px solid blue; padding: 3px 10px; border-radius: 10px;">{{ asset.countBlocked }} Feltételesen foglalt!</strong>
                                                    </li>
                                                {% endif %}
                                                {% if searchResults.PROJECT.ID and asset.countAvailable == 0 and not asset.isAssetReleased %}
                                                    <li class="small" title="Nincs elérhető készlet" style="margin-top: 10px;">
                                                        <strong style="font-size: larger; color: red; border: 2px solid red; padding: 3px 10px; border-radius: 10px;">Nincs elérhető készlet!</strong>
                                                    </li>
                                                {% endif %}
                                                {% if searchResults.PROJECT.ID and asset.countAvailable == 1 and not asset.isAssetReleased %}
                                                    <li class="small" title="Utolsó darab" style="margin-top: 10px;">
                                                        <strong style="font-size: larger; color: black; border: 2px solid orange; padding: 3px 10px; border-radius: 10px;">Utolsó darab!</strong>
                                                    </li>
                                                {% endif %}
                                                {% if searchResults.PROJECT.ID and asset.countAvailable <= 3 and asset.countAvailable != 1 and asset.countAvailable != 0 and not asset.isAssetReleased %}
                                                    <li class="small" title="Utolsó darabok" style="margin-top: 10px;">
                                                        <strong style="font-size: larger; color: black; border: 2px solid yellow; padding: 3px 10px; border-radius: 10px;">Utolsó darabok!</strong>
                                                    </li>
                                                {% endif %}
                                                {% if asset.hasSubAssets %}
                                                    <li class="small" title="Aleszközöket tartalmaz" style="margin-top: 10px;">
                                                        <strong style="font-size: larger; color: green; border: 2px solid green; padding: 3px 10px; border-radius: 10px;">
                                                            {{ asset.countSubAssets }} Aleszközt tartalmaz!
                                                        </strong>
                                                    </li>
                                                {% endif %}
                                                {% if asset.extra_assets != 0 %}
                                                    <li class="small" title="Raktárkészleten felül" style="margin-top: 10px;">
                                                        <strong style="font-size: larger; color: red; border: 2px solid red; padding: 3px 10px; border-radius: 10px;">{{ asset.extra_assets }} Raktáron felül!</strong>
                                                    </li>
                                                {% endif %}
                                            {% endif %}

                                            {% if searchResults.SEARCH.INSTANCE_ID != USERDATA.instance.instances_id %}
                                                {% for instance in USERDATA.instances %}
                                                    {% if searchResults.SEARCH.INSTANCE_ID == instance.instances_id %}
                                                        <li class="small"><span class="fa-li"><i class="fas fa-exclamation-triangle"></i></span> Vállalkozás: {{instance.instances_name}}</li>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}

                                        </ul>
                                    </div>
                                    <div class="card-footer">
                                        <div class="text-right">
                                            <div class="btn-group">
                                                {% if searchResults.PROJECT.ID and "PROJECTS:PROJECT_ASSETS:CREATE:ASSIGN_AND_UNASSIGN"|instancePermissions %}
                                                    {% if asset.count == 1 %}
                                                        {% if asset.tags[0].assets_endDate != null and asset.tags[0].assets_endDate < searchResults.PROJECT['DATEEND'] %}
                                                            <button title="Eszközt archíválni kell" class="btn btn-sm btn-success" disabled><i class="fa fa-shopping-basket"></i></button>
                                                        {% elseif asset.tags[0].flagsblocks.COUNT.BLOCK < 1 %}
                                                            <button title="Eltávolítás a projektről" {% if (not asset.tags[0].assignment) or searchResults.PROJECT.ID != asset.tags[0].assignment[0].projects_id %}style="display:none;"{% endif %} class="btn btn-sm btn-warning removeFromBasketAssetButton" data-assetid="{{ asset.tags[0]['assets_id'] }}"><i class="fa fa-shopping-basket"></i></button>
                                                            {% if asset.tags[0].assignment and searchResults.PROJECT.ID != asset.tags[0].assignment[0].projects_id %}
                                                                <button title="Hozzárendelve a {{ asset.tags[0].assignment[0]['projects_name'] }} projekthez" class="btn btn-sm btn-success" disabled><i class="fa fa-shopping-basket"></i></button>
                                                            {% endif %}
                                                            <button title="Hozzáadás a projekthez" {% if asset.tags[0].assignment %} style="display:none;"{% endif %} class="btn btn-sm btn-success addToBasketAssetButton" data-assetid="{{ asset.tags[0]['assets_id'] }}"><i class="fa fa-shopping-basket"></i></button>
                                                        {% else %}
                                                            <button class="btn btn-sm btn-danger" title="Az eszköz hozzárendelését karbantartási feladat blokkolja" disabled><i class="fas fa-ban"></i></button>
                                                        {% endif %}
                                                    {% else %}
                                                        <div class="modal fade" id="assetDetailsModal{{ asset.assetTypes_id }}">
                                                            <div class="modal-dialog modal-xl">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h4 class="modal-title">{{ asset.assetTypes_name }}</h4>
                                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                    </div>
                                                                    <div class="modal-body" style="padding:0;text-align:left;overflow-x: auto;">
                                                                        <table class="table table-striped">
                                                                            <tr>
                                                                                <th style="width:70px;">ID</th>
                                                                                {% for field in asset.fields %}
                                                                                    <th>{{ field }}</th>
                                                                                {% endfor %}
                                                                                <th>Megjegyzések</th>
                                                                                {% if "ASSETS:ASSET_TYPES:EDIT"|instancePermissions %}
                                                                                    <th>Díj/nap</th>
                                                                                    <th>Díj/hét</th>
                                                                                {% endif %}
                                                                                <th style="width:1%"><i class="fas fa-flag"></i></th>
                                                                                <th style="width:30px;">
                                                                                    {% set not_valid = 0 %}
                                                                                    {% for thisasset in asset.tags %}
                                                                                        {% if thisasset.assignment and searchResults.PROJECT.ID != thisasset.assignment[0].projects_id %}
                                                                                            {% set not_valid = 1 %}
                                                                                        {% endif %}
                                                                                    {% endfor %}
                                                                                    <button class="btn btn-success addToBasketAssetTypeButton" {% if asset.countAvailable < 1 or asset.hasSubAssets %} disabled {% endif %} title="Az összes ilyen típusú eszköz hozzáadása a projekthez" data-assetTypeId="{{ asset.assetTypes_id }}"><i class="fas fa-dolly"></i></button>
                                                                                    <button class="btn btn-danger removeFromBasketAssetTypeButton" {% if asset.countAvailable == asset.count or not_valid == 1 or asset.hasSubAssets %} disabled {% endif %} title="Az összes ilyen típusú eszköz eltávolítása a projektről" data-assetTypeId="{{ asset.assetTypes_id }}"><i class="fas fa-dolly"></i></button>
                                                                                </th>
                                                                            </tr>
                                                                            {% for thisasset in asset.tags %}
                                                                                <tr>
                                                                                    <td>{{ thisasset.assets_tag|aTag }}</td>
                                                                                    {% for field in asset.fields %}
                                                                                        <td>{{ thisasset['asset_definableFields_' ~ loop.index] }}</td>
                                                                                    {% endfor %}
                                                                                    <td>{{ thisasset['assets_notes']|nl2br }}</td>
                                                                                    <td>
                                                                                        {{ (thisasset.assets_dayRate ?: asset.assetTypes_dayRate)|money(SEARCH.INSTANCE['instances_config_currency'])|replace({',00':''}) }}
                                                                                    </td>
                                                                                    <td>
                                                                                        {{ (thisasset.assets_weekRate ?: asset.assetTypes_weekRate)|money(SEARCH.INSTANCE['instances_config_currency'])|replace({',00':''}) }}
                                                                                    </td>
                                                                                    <td>
                                                                                        {{ thisasset.flagsblocks.COUNT.FLAG > 0 ?: '' }}
                                                                                    </td>
                                                                                    <td>
                                                                                        <div class="btn-group">
                                                                                            {% if thisasset.assets_endDate != null and thisasset.assets_endDate < searchResults.PROJECT['DATEEND'] %}
                                                                                                <button title="Eszköz eltávolításra kerül" class="btn btn-sm btn-success" disabled><i class="fa fa-shopping-basket"></i></button>
                                                                                            {% elseif thisasset.flagsblocks.COUNT.BLOCK < 1 %}
                                                                                                <button title="Eltávolítás a projektből" {% if (not thisasset.assignment) or searchResults.PROJECT.ID != thisasset.assignment[0].projects_id %}style="display:none;"{% endif %} class="btn btn-sm btn-warning removeFromBasketAssetButton" data-assetid="{{ thisasset['assets_id'] }}" data-assetTypeId="{{ asset.assetTypes_id }}"><i class="fa fa-shopping-basket"></i></button>
                                                                                                {% if thisasset.assignment and searchResults.PROJECT.ID != thisasset.assignment[0].projects_id %}
                                                                                                    <button title="Hozzárendelve ehhez: {{ thisasset.assignment[0]['projects_name'] }}" class="btn btn-sm btn-success" disabled><i class="fa fa-shopping-basket"></i></button>
                                                                                                {% endif %}
                                                                                                <button title="Hozzáadás a projekthez" {% if thisasset.assignment %} style="display:none;"{% endif %} class="btn btn-sm btn-success addToBasketAssetButton" data-assetid="{{ thisasset['assets_id'] }}" data-assetTypeId="{{ asset.assetTypes_id }}"><i class="fa fa-shopping-basket"></i></button>
                                                                                            {% else %}
                                                                                                <button class="btn btn-sm btn-danger" title="Az eszköz karbantartási munka miatt blokkolva van" disabled><i class="fas fa-ban"></i></button>
                                                                                            {% endif %}
                                                                                        </div>
                                                                                    </td>
                                                                                </tr>
                                                                            {% endfor %}
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <button type="button" class="btn btn-sm {{ asset.countAvailable > 0 ? 'btn-success' : 'btn-warning' }}" title="Hozzárendelés a raktárból" data-toggle="modal" data-target="#assetDetailsModal{{ asset.assetTypes_id }}"><i class="fa fa-shopping-basket"></i></button>
                                                        <button type="button" class="btn btn-sm btn-primary" title="Raktárkészleten felüli mennyiség hozzárendelése készlettől teljesen függetlenül" data-toggle="modal" data-target="#assignExtraAssetModal{{ asset.assetTypes_id }}">
                                                            <i class="fa fa-plus"></i>
                                                        </button>  
                                                        <div class="modal fade" id="assignExtraAssetModal{{ asset.assetTypes_id }}" tabindex="-1" role="dialog" aria-labelledby="assignExtraAssetModalLabel{{ asset.assetTypes_id }}" aria-hidden="true">
                                                            <div class="modal-dialog" role="document">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title" id="assignExtraAssetModalLabel{{ asset.assetTypes_id }}">Eszköz hozzárendelés készlettől függetlenül: <strong>{{ asset.assetTypes_name }}</strong></h5>
                                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Bezárás">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        <div class="form-group">
                                                                            <label for="quantity{{ asset.assetTypes_id }}">Mennyiség</label>
                                                                            <input type="number" class="form-control assignExtraInput" id="quantity{{ asset.assetTypes_id }}" required>
                                                                        </div>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button 
                                                                            type="button" 
                                                                            class="btn btn-success assignExtraAssetButton" 
                                                                            data-assettypeid="{{ asset.assetTypes_id }}" 
                                                                            data-projectid="{{ searchResults.SEARCH.PROJECT_ID }}"
                                                                            data-action="add">
                                                                            Hozzáadás
                                                                        </button>
                                                                        <button 
                                                                            type="button" 
                                                                            class="btn btn-warning assignExtraAssetButton" 
                                                                            data-assettypeid="{{ asset.assetTypes_id }}" 
                                                                            data-projectid="{{ searchResults.SEARCH.PROJECT_ID }}"
                                                                            data-action="remove">
                                                                            Eltávolítás
                                                                        </button>
                                                                        <button 
                                                                            type="button" 
                                                                            class="btn btn-danger assignExtraAssetButton" 
                                                                            data-assettypeid="{{ asset.assetTypes_id }}" 
                                                                            data-projectid="{{ searchResults.SEARCH.PROJECT_ID }}"
                                                                            data-action="remove_all">
                                                                            Összes eltávolítása
                                                                        </button>
                                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Mégse</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                 
                                                    {% endif %}
                                                {% elseif searchResults.PROJECT.DATESTART and searchResults.PROJECT.DATEEND %}
                                                    {% if asset.count == 1 %}
                                                        {% if asset.tags[0].assets_endDate != null and asset.tags[0].assets_endDate < searchResults.PROJECT['DATEEND'] %}
                                                            <button title="Eszköz archiválásra kerül" class="btn btn-sm btn-danger" disabled><i class="fa fa-times"></i></button>
                                                        {% elseif asset.tags[0].flagsblocks.COUNT.BLOCK < 1 %}
                                                            {% if asset.tags[0].assignment %}
                                                                <button title="Hozzárendelve ehhez: {{ asset.tags[0].assignment[0]['projects_name'] }}" class="btn btn-sm btn-danger" disabled><i class="fa fa-times"></i></button>
                                                            {% else %}
                                                                <button title="Elérhető" class="btn btn-sm btn-success" disabled><i class="fa fa-check"></i></button>
                                                            {% endif %}
                                                        {% else %}
                                                            <button class="btn btn-sm btn-danger" title="Az eszköz karbantartási munka miatt blokkolva van" disabled><i class="fas fa-ban"></i></button>
                                                        {% endif %}
                                                    {% else %}
                                                        <div class="modal fade" id="assetDetailsModal{{ asset.assetTypes_id }}">
                                                            <div class="modal-dialog modal-xl">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h4 class="modal-title">{{ asset.assetTypes_name }}</h4>
                                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                    </div>
                                                                    <div class="modal-body" style="padding:0;text-align:left;overflow-x: auto;">
                                                                        <table class="table table-striped">
                                                                            <tr>
                                                                                <th style="width:70px;">ID</th>
                                                                                {% for field in asset.fields %}
                                                                                    <th>{{ field }}</th>
                                                                                {% endfor %}
                                                                                <th>Notes</th>
                                                                                {% if "ASSETS:ASSET_TYPES:EDIT"|instancePermissions %}
                                                                                    <th>Díj/nap</th>
                                                                                    <th>Díj/hét</th>
                                                                                {% endif %}
                                                                                <th style="width:1%"><i class="fas fa-flag"></i></th>
                                                                                <th style="width:30px;"></th>
                                                                            </tr>
                                                                            {% for thisasset in asset.tags %}
                                                                                <tr>
                                                                                    <td>{{ thisasset.assets_tag|aTag }}</td>
                                                                                    {% for field in asset.fields %}
                                                                                        <td>{{ thisasset['asset_definableFields_' ~ loop.index] }}</td>
                                                                                    {% endfor %}
                                                                                    <td>{{ thisasset['assets_notes']|nl2br }}</td>
                                                                                    <td>
                                                                                        {{ (thisasset.assets_dayRate ?: asset.assetTypes_dayRate)|money(SEARCH.INSTANCE['instances_config_currency'])|replace({',00':''}) }}
                                                                                    </td>
                                                                                    <td>
                                                                                        {{ (thisasset.assets_weekRate ?: asset.assetTypes_weekRate)|money(SEARCH.INSTANCE['instances_config_currency'])|replace({',00':''}) }}
                                                                                    </td>
                                                                                    <td>
                                                                                        {{ thisasset.flagsblocks.COUNT.FLAG > 0 ?: '' }}
                                                                                    </td>
                                                                                    <td>
                                                                                        <div class="btn-group">
                                                                                            {% if thisasset.assets_endDate != null and thisasset.assets_endDate < searchResults.PROJECT['DATEEND'] %}
                                                                                                <button title="Eszköz eltávolításra kerül" class="btn btn-sm btn-danger" disabled><i class="fa fa-times"></i></button>
                                                                                            {% elseif thisasset.flagsblocks.COUNT.BLOCK < 1 %}
                                                                                                {% if thisasset.assignment %}
                                                                                                    <button title="Hozzárendelve ehhez: {{ thisasset.assignment[0]['projects_name'] }}" class="btn btn-sm btn-danger" disabled><i class="fa fa-times"></i></button>
                                                                                                {% else %}
                                                                                                    <button title="Elérhető" class="btn btn-sm btn-success" disabled><i class="fa fa-check"></i></button>
                                                                                                {% endif %}
                                                                                            {% else %}
                                                                                                <button class="btn btn-sm btn-danger" title="Az eszköz karbantartási munka miatt blokkolva van" disabled><i class="fas fa-ban"></i></button>
                                                                                            {% endif %}
                                                                                        </div>
                                                                                    </td>
                                                                                </tr>
                                                                            {% endfor %}
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <button type="button" class="btn btn-sm {{ asset.countAvailable > 0 ? 'btn-success' : 'btn-warning' }}" data-toggle="modal" data-target="#assetDetailsModal{{ asset.assetTypes_id }}"><i class="fa fa-calendar"></i></button>
                                                {% endif %}
                                            {% endif %}
                                                <a href="{{ CONFIG.ROOTURL }}/asset.php?id={{ asset.assetTypes_id }}{{ asset.count == 1 ? '&asset=' ~ asset.tags[0]['assets_id'] : '' }}{{ SEARCH["SETTINGS"]["SHOWARCHIVED"] ? '&showArchived' : ''}}&instance={{ searchResults.SEARCH.INSTANCE_ID }}" class="btn btn-sm btn-default" target="_blank">
                                                    <i class="fas fa-info-circle"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="card-footer">
                <div class="card-tools float-right">
                {% if searchResults.PAGINATION['TOTAL-PAGES'] > 1 %}
                    <ul class="pagination pagination-sm m-0">
                        {% if searchResults.PAGINATION.PAGE > 1 %}
                            <li class="page-item"><a class="page-link" href="#" data-page="{{ (searchResults.PAGINATION.PAGE -1) }}">&laquo;</a></li>
                        {% endif %}

                        {% for i in range((searchResults.PAGINATION.PAGE > 3 ? searchResults.PAGINATION.PAGE-2 : 1), (searchResults.PAGINATION['TOTAL-PAGES'] > 5 and searchResults.PAGINATION.PAGE+2 < searchResults.PAGINATION['TOTAL-PAGES'] ? searchResults.PAGINATION.PAGE+2 : searchResults.PAGINATION['TOTAL-PAGES'])) %}
                            <li class="page-item"><a class="page-link" href="#" data-page="{{ i }}">
                                    {% if searchResults.PAGINATION.PAGE == i %}
                                        <b>{{ i }}</b>
                                    {% else %}
                                        {{ i }}
                                    {% endif %}
                                </a></li>
                        {% endfor %}
                        {% if searchResults.PAGINATION.PAGE < searchResults.PAGINATION['TOTAL-PAGES'] %}
                            <li class="page-item"><a class="page-link" href="#" data-page="{{searchResults.PAGINATION.PAGE+1}}">&raquo;</a></li>
                        {% endif %}
                    </ul>
                {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="card card-solid">
            <div class="card-header">
                <h3 class="card-title" style="margin-top: 0.4rem;">
                    Nincs találat
                </h3>
            </div>
        </div>
        {% endif %}
    </div>
</div>
<script>
function replaceQueryParam(param, newval, search) {
    var regex = new RegExp("([?;&])" + param + "[^&;]*[;&]?");
    var query = search.replace(regex, "$1").replace(/&$/, '');

    return (query.length > 2 ? query + "&" : "?") + (newval ? param + "=" + newval : '');
}

document.getElementById('hidesubassets').addEventListener('change', function() {
    if (this.checked) {
        document.getElementById('showsubassets').checked = false;
    }
});

document.getElementById('showsubassets').addEventListener('change', function() {
    if (this.checked) {
        document.getElementById('hidesubassets').checked = false;
    }
});

document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.assignExtraAssetButton').forEach(function (button) {
        button.addEventListener('click', function () {
            const assetTypeId = this.dataset.assettypeid;
            const projectId = this.dataset.projectid;
            const action = this.dataset.action;
            const input = document.getElementById('quantity' + assetTypeId);
            const quantity = parseInt(input.value) || 0;

            ajaxcall("projects/assets/assignExtraAsset.php", {
                asset_id: assetTypeId,
                project_id: projectId,
                quantity: quantity,
                action: action
            }, function () {
                $('#assignExtraAssetModal' + assetTypeId).modal('hide');
                location.reload();
            });
        });
    });
});


$(document).ready(function () {
    $('#assetSearchForm input[name ="dates"]').daterangepicker({
        timePicker: true,
        timePickerIncrement: 15,
        timePicker24Hour: true,
                locale: {
                    format: 'YYYY. MM. DD. HH:mm',
                    applyLabel: 'Alkalmaz', 
                    cancelLabel: 'Mégsem',
                    customRangeLabel: 'Egyéni időszak',
                    daysOfWeek: ['V', 'H', 'K', 'Sze', 'Cs', 'P', 'Szo'],
                    monthNames: ['Január', 'Február', 'Március', 'Április', 'Május', 'Június', 'Július', 'Augusztus', 'Szeptember', 'Október', 'November', 'December'],
                    firstDay: 1
                },
        autoUpdateInput: false,
    });
    $('#assetSearchForm input[name ="dates"]').on('apply.daterangepicker', function(ev, picker) {
        $(this).val(picker.startDate.format('YYYY. MM. DD. HH:mm') + ' - ' + picker.endDate.format('YYYY. MM. DD. HH:mm'));
    });
    $('#assetSearchForm input[name ="dates"]').on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
    });
    $('#assetSearchForm .select2').select2({
        theme: "bootstrap4",
        width: '100%'
    });
    $('#assetSearchForm select[name ="keyword[]"]').select2({
        tags: true,
        tokenSeparators: [',', ';'],
        multiple: true,
        theme: "bootstrap4",
        minimumInputLength: 1,
        width: '100%',
        placeholder: "WPC, WMP, MPT",
    });
    $('#assetSearchForm select[name ="tags[]"]').select2({
        tags: true,
        tokenSeparators: [' ', ',',';'],
        multiple: true,
        theme: "bootstrap4",
        minimumInputLength: 1,
        width: '100%',
        placeholder: "A-1053, D-0056",
    });
    $('#assetSearchForm select[name ="manufacturer[]"]').select2({
        tags: false,
        multiple: true,
        theme: "bootstrap4",
        minimumInputLength: 0,
        width: '100%',
        minimumResultsForSearch: 1,
        placeholder: "Adjon meg néhány gyártónevet a kereséshez",
        ajax: {
            delay: 250,
            url: "{{ CONFIG.ROOTURL }}/api/manufacturer/search.php",
            dataType: "json",
            type: "POST",
            data: function (params) {
                var queryParameters = {
                    term: params.term,
                    instance_id: $("#assetSearchForm select[name='instance_id']").val()
                }
                return queryParameters;
            },
            processResults: function (data) {
                if (data && data.result && data.response) {
                    return {
                        results: $.map(data.response, function (item) {
                            return {
                                text: item.manufacturers_name,
                                id: item.manufacturers_id
                            }
                        })
                    };
                } else return {
                    results: []
                };
            }
        }
    });
    $('#assetSearchForm select[name ="category[]"]').select2({
        tags: false,
        multiple: true,
        theme: "bootstrap4",
        minimumInputLength: 0,
        width: '100%',
        minimumResultsForSearch: 1,
        placeholder: "Adjon meg néhány kategórianevet a kereséshez",
        ajax: {
            delay: 250,
            url: "{{ CONFIG.ROOTURL }}/api/categories/search.php",
            dataType: "json",
            type: "POST",
            data: function (params) {
                var queryParameters = {
                    term: params.term,
                    instance_id: $("#assetSearchForm select[name='instance_id']").val()
                }
                return queryParameters;
            },
            processResults: function (data) {
                if (data && data.result && data.response) {
                    return {
                        results: $.map(data.response, function (item) {
                            return {
                                text: item.assetCategoriesGroups_name + " - " + item.assetCategories_name,
                                id: item.assetCategories_id
                            }
                        })
                    };
                } else return {
                    results: []
                };
            }
        }
    });
    $('#assetSearchForm select[name ="group[]"]').select2({
        tags: false,
        multiple: true,
        theme: "bootstrap4",
        minimumInputLength: 1,
        width: '100%',
        minimumResultsForSearch: 1,
        placeholder: "Adjon meg néhány csoportnevet a kereséshez",
        ajax: {
            delay: 250,
            url: "{{ CONFIG.ROOTURL }}/api/groups/search.php",
            dataType: "json",
            type: "POST",
            data: function (params) {
                var queryParameters = {
                    term: params.term
                }
                return queryParameters;
            },
            processResults: function (data) {
                if (data && data.result && data.response) {
                    return {
                        results: $.map(data.response, function (item) {
                            return {
                                text: item.assetGroups_name,
                                id: item.assetGroups_id
                            }
                        })
                    };
                } else return {
                    results: []
                };
            }
        }
    });
    $(document).on("click",".page-link[data-page]",function () {
        var str = window.location.search
        str = replaceQueryParam('page', $(this).data("page"), str)
        window.location = window.location.pathname + str
    });
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000
    });
    $('.slick').slick({
        dots: false,
        arrows: false,
        focusOnSelect: true,
        pauseOnHover: true,
        draggable: false,
        infinite: true,
        slidesToShow: 1,
        slidesToScroll: 1,
        autoplay: true,
        autoplaySpeed: 2000,
    });
    {% if searchResults.PROJECT.ID != null and "PROJECTS:PROJECT_ASSETS:CREATE:ASSIGN_AND_UNASSIGN"|instancePermissions %}
    $(".addToBasketAssetButton").click(function () {
        var assetId = $(this).data("assetid");

        // Fetch sub-assets first
        ajaxcall("assets/getSubAssetData.php", { "assets_id": assetId }, function (data) {
            console.log("Received response:", data);

            if (data.response.hasSubAssets) {
                console.log("Asset has sub-assets. Processing...");

                let hasInsufficientStock = false;
                let shortageDetails = [];

                // Ellenőrizzük az összes al-eszközt
                let requests = data.response.subAssets.map(subAsset => {
                    return new Promise((resolve, reject) => {
                        ajaxcall("assets/getCountAvailable.php", {
                            "assets_id": subAsset.id,
                            "project_id": "{{ searchResults.SEARCH.PROJECT_ID }}"                           
                             }, function (countData) {
                            console.log("Received count data:", countData);

                            if (countData.result && countData.response.length > 0) {
                                let availableAssets = countData.response.flatMap(res => res.availableAssets || []); // Az összes availableAssets összegyűjtése

                                let totalAvailable = availableAssets.length;
                                let shortage = subAsset.quantity - totalAvailable;
                                
                                if (totalAvailable >= subAsset.quantity) {
                                    let assignPromises = [];
                                    let assignedCount = 0;

                                    // Haladunk előre, és amint egy eszközt találunk, hozzárendeljük
                                    for (let i = 0; i < availableAssets.length; i++) {

                                        console.log(assignedCount)

                                        if (assignedCount >= subAsset.quantity){
                                            break;
                                        } 

                                        let availableAsset = availableAssets[i]; // Az elérhető eszközök listájának megfelelő eszköze

                                        assignPromises.push(new Promise((res, rej) => {
                                            ajaxcall("projects/assets/assign.php", {
                                                "assets_id": availableAsset,
                                                 "projects_id": "{{ searchResults.SEARCH.PROJECT_ID }}",
                                                "assignedAsSubAsset": true
                                            }, function (response) {
                                                
                                                console.log("✅ Sub-asset assigned successfully!", {
                                                    subAssetId: subAsset.id,
                                                    response: response
                                                });
                                                res();
                                            });
                                        }));
                                        assignedCount++; 
                                    }

                                    // Az összes hozzárendelést végre kell hajtani, mielőtt folytatjuk
                                    Promise.all(assignPromises).then(() => {
                                        resolve(); // Ha minden hozzárendelés sikerült
                                    }).catch(reject);

                                } else {
                                    // Fetch the asset name if there's insufficient stock
                                    ajaxcall("assets/getAssetName.php", { "id": subAsset.id }, function (response) {
                                        console.log("Response Object: ", response);
                                        if (response.response.assetName) {
                                            console.log("❌ Nincs elegendő eszköz raktáron! Eszköz neve: " + response.assetName + ", Szükséges: " + subAsset.quantity + ", Elérhető: " + totalAvailable);
                                            hasInsufficientStock = true;
                                            shortageDetails.push("Eszköz típus: " + response.response.assetName + " | ID: " + subAsset.id + " | Szükséges: " + subAsset.quantity + " | Raktáron: " + totalAvailable + " | Hiányzik: " + (shortage > 0 ? shortage : 0));
                                        } else {
                                            console.log("❌ Nincs elegendő eszköz raktáron! Eszköz ID: " + subAsset.id + " | Szükséges: " + subAsset.quantity + ", Elérhető: " + totalAvailable);
                                            hasInsufficientStock = true;
                                            shortageDetails.push("ID: " + subAsset.id + " | Szükséges: " + subAsset.quantity + " | Raktáron: " + totalAvailable + " | Hiányzik: " + (shortage > 0 ? shortage : 0));
                                        }
                                        reject(); // Stop the operation if stock is insufficient
                                    });
                                }
                            } else {
                                console.log("⚠ Hiba: Nem érkezett megfelelő válasz a készlet lekérdezésére.");
                                reject();
                            }
                        });
                    });
                });
                // Várjuk meg az összes al-eszköz ellenőrzését
                Promise.allSettled(requests).then(results => {
                    if (hasInsufficientStock) {
                        console.log("⛔ Az al-eszközök között nincs elegendő készlet. A fő eszközt NEM adjuk hozzá.");
                        // Frontend értesítés
                        Swal.fire({
                            icon: 'error',
                            title: 'Hiba',
                            html: 'Nincs elegendő al-eszköz készleten! A fő eszközt nem adtuk hozzá.<br><br>' + shortageDetails.join('<br>'),
                            confirmButtonText: 'OK'
                        });
                        return; // Ha bármelyik al-eszköz nem elérhető, nem folytatjuk a fő eszköz hozzárendelését
                    }

                    // Ha minden rendben van, hozzárendeljük a fő eszközt
                    ajaxcall("projects/assets/assign.php", {
                        "assets_id": assetId,
                        "projects_id": "{{ searchResults.SEARCH.PROJECT_ID }}",
                        "assignedAsSubAsset": false
                    }, function (response) {
                        $(".addToBasketAssetButton[data-assetid='" + assetId + "']").hide();
                        $(".removeFromBasketAssetButton[data-assetid='" + assetId + "']").show();

                        Toast.fire({
                            icon: 'success',
                            title: 'Hozzáadva ehhez: {{ searchResults.PROJECT.NAME }}'
                        });

                        console.log("Asset assigned:", response);
                    });
                });
            } else {
                // Ha nincs al-eszköz, akkor a fő eszközt automatikusan hozzárendeljük
                ajaxcall("projects/assets/assign.php", {
                    "assets_id": assetId,
                    "projects_id": "{{ searchResults.SEARCH.PROJECT_ID }}",
                    "assignedAsSubAsset": false
                }, function (response) {
                    $(".addToBasketAssetButton[data-assetid='" + assetId + "']").hide();
                    $(".removeFromBasketAssetButton[data-assetid='" + assetId + "']").show();

                    Toast.fire({
                        icon: 'success',
                        title: 'Hozzáadva ehhez: {{ searchResults.PROJECT.NAME }}'
                    });

                    console.log("Asset assigned:", response);
                });
            }
        });
    });
    $(".addToBasketAssetTypeButton").click(function () {
        const thisButton = $(this);
        var assetTypeId = thisButton.data("assettypeid");
        ajaxcall("projects/assets/assign.php", {"assetTypes_id":assetTypeId,
        "projects_id":"{{ searchResults.SEARCH.PROJECT_ID }}",
        "assignedAsSubAsset": false
        }, function (data) {
            $(".addToBasketAssetButton[data-assettypeid=" + assetTypeId + "]").hide();
            $(".removeFromBasketAssetButton[data-assettypeid=" + assetTypeId + "]").show();
            thisButton.prop('disabled', true);
            Toast.fire({
                type: 'success',
                title: 'Hozzáadva ehhez: {{ searchResults.PROJECT.NAME }}'
            });
        });
    });
    $(".removeFromBasketAssetButton").click(function () {
        var assetId = $(this).data("assetid");
        bootbox.confirm({
            message: "Biztosan el szeretné távolítani ezt az eszközt a projektből?",
            buttons: {
                confirm: {
                    label: 'Igen',
                    className: 'btn-danger'
                },
                cancel: {
                    label: 'Nem',
                    className: 'btn-success'
                }
            },
            callback: function (result) {
                if (result) {
                    // Először ellenőrizzük, hogy vannak-e al-eszközök
                    ajaxcall("assets/getSubAssetData.php", { "assets_id": assetId }, function (data) {
                        console.log("Received response:", data);
                        
                        if (data.response.hasSubAssets) {
                            console.log("Asset has sub-assets. Removing...");

                            let requests = data.response.subAssets.map(subAsset => {
                                return new Promise((resolve, reject) => {
                                    ajaxcall("projects/assets/unassign.php", {
                                        "assetTypes_id": subAsset.id,
                                        "projects_id": "{{ searchResults.SEARCH.PROJECT_ID }}"
                                    }, function (response) {
                                        console.log("✅ Sub-asset unassigned successfully!", {
                                            subAssetId: subAsset.id,
                                            response: response
                                        });
                                        resolve();
                                    });
                                });
                            });

                            // Várjuk meg az összes al-eszköz eltávolítását
                            Promise.allSettled(requests).then(() => {
                                // Ha minden al-eszköz eltávolítva, eltávolítjuk a fő eszközt is
                                ajaxcall("projects/assets/unassign.php", { "assets_id": assetId, "projects_id": "{{ searchResults.SEARCH.PROJECT_ID }}" }, function (data) {
                                    $(".addToBasketAssetButton[data-assetid='" + assetId + "']").show();
                                    $(".removeFromBasketAssetButton[data-assetid='" + assetId + "']").hide();
                                    Toast.fire({
                                        icon: 'success',
                                        title: 'Eltávolítva innen: {{ searchResults.PROJECT.NAME }}'
                                    });
                                    console.log("Asset removed:", data);
                                });
                            });
                        } else {
                            // Ha nincs al-eszköz, akkor csak a fő eszközt távolítjuk el
                            ajaxcall("projects/assets/unassign.php", { "assets_id": assetId, "projects_id": "{{ searchResults.SEARCH.PROJECT_ID }}" }, function (data) {
                                $(".addToBasketAssetButton[data-assetid='" + assetId + "']").show();
                                $(".removeFromBasketAssetButton[data-assetid='" + assetId + "']").hide();
                                Toast.fire({
                                    icon: 'success',
                                    title: 'Eltávolítva innen: {{ searchResults.PROJECT.NAME }}'
                                });
                                console.log("Asset removed:", data);
                            });
                        }
                    });
                }
            }
        });
    });
    // Implement bulk remove
    $(".removeFromBasketAssetTypeButton").click(function () { // Bulk remove
        const thisButton = $(this);
        var assetTypeId = thisButton.data("assettypeid");
        bootbox.confirm({
            message: "Biztosan el szeretné távolítani az összes ilyen típusú eszközt a projektből?",
            buttons: {
                confirm: {
                    label: 'Igen',
                    className: 'btn-danger'
                },
                cancel: {
                    label: 'Nem',
                    className: 'btn-success'
                }
            },
            callback: function (result) {
                if (result) {
                    ajaxcall("projects/assets/unassign.php", {"assetTypes_id":assetTypeId,"projects_id":"{{ searchResults.SEARCH.PROJECT_ID }}"}, function (data) {
                        $(".addToBasketAssetButton[data-assettypeid=" + assetTypeId + "]").show();
                        $(".removeFromBasketAssetButton[data-assettypeid=" + assetTypeId + "]").hide();
                        thisButton.prop('disabled', true);
                        Toast.fire({
                            type: 'success',
                            title: 'Eltávolítva innen: {{ searchResults.PROJECT.NAME }}'
                        });
                    });
                }
            }
        });
    });
        



    {% endif %}
});
</script>
{% endblock %}
