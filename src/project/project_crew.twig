<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title">Stáb</h3>
                    <div class="btn-group ml-auto">
                        {% if "PROJECTS:PROJECT_CREW:CREATE"|instancePermissions %}
                            <button type="button" class="btn btn-default btn-small" data-toggle="modal" data-target="#addCrewModal">Stáb hozzáadása</button>
                        {% endif %}
                        {% if "PROJECTS:PROJECT_CREW:VIEW:EMAIL_CREW"|instancePermissions and project.crewAssignments|length > 0 %}
                            <button type="button" class="btn btn-default btn-small" data-toggle="modal" data-target="#emailCrewModal">Stáb e-mail küldése</button>
                        {% endif %}
                    </div>
            </div>
            <div class="card-body p-0">
                <ul id="crewList" class="todo-list">
                    {% for crew in project.crewAssignments %}
                        <li value="{{crew.crewAssignments_id}}"
                            {% if crew.users_userid is null and crew.crewAssignments_personName is null %}
                            class="danger"
                            {% elseif crew.users_email|length < 1 %}
                            class="warning"
                            {% endif %}>
                            {% if "PROJECTS:PROJECT_CREW:EDIT:CREW_RANKS"|instancePermissions %}
                                <span class="handle">
                                    <i class="fas fa-ellipsis-v"></i>
                                    <i class="fas fa-ellipsis-v"></i>
                                </span>
                            {% endif %}
                                <span class="text">
                                    {{crew.crewAssignments_role}} -
                                    {% if crew.users_userid is null and crew.crewAssignments_personName is null %}
                                        <i>Szabad</i>
                                    {% elseif crew.users_name1 %}
                                        {% if "BUSINESS:USERS:VIEW:INDIVIDUAL_USER"|instancePermissions %}
                                            <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ crew.users_userid }}">
                                        {% endif %}
                                        {{ crew.users_name1 ~ " " ~ crew.users_name2 }}
                                        {% if "BUSINESS:USERS:VIEW:INDIVIDUAL_USER"|instancePermissions %}
                                            </a>
                                        {% endif %}
                                        {% if crew.users_social_mobilephone %}
                                            - Telefonszám: 
                                            <a href="tel:{{ crew.users_social_mobilephone }}">{{ crew.users_social_mobilephone }}</a>
                                        {% endif %}
                                    {% else %}
                                        {{ crew.crewAssignments_personName }}
                                    {% endif %}
                                </span>
                            {% if crew.crewAssignments_comment|length > 0 %}
                                <i class="fas fa-info-circle" data-toggle="popover" title="{{crew.crewAssignments_role|escape('html_attr')}}" data-content="{{ crew.crewAssignments_comment|escape('html_attr') }}"></i>
                            {% endif %}
                            <div class="tools">
                                {% set response = crew.crewAssignments_response %}
                                {% if crew.users_userid == user.users_userid or "PROJECTS:PROJECT_CREW:EDIT"|instancePermissions %}
                                    <!-- Zöld checkbox (Elfogadás) csak akkor, ha van értéke -->
                                    {% if response == 1 %}
                                        <i class="fas fa-check-circle confirmCrewAssignment"
                                        data-assignment='{"assignmentId": "{{ crew.crewAssignments_id }}", "userId": "{{ crew.users_userid }}", "projectId": "{{ crew.projects_id }}", "response": 1}'
                                        title="Visszaigazolva"
                                        style="color: green; cursor: pointer; margin-right: 10px;">
                                        </i>
                                    {% else %}
                                        <i class="far fa-circle confirmCrewAssignment"
                                        data-assignment='{"assignmentId": "{{ crew.crewAssignments_id }}", "userId": "{{ crew.users_userid }}", "projectId": "{{ crew.projects_id }}", "response": 1}'
                                        title="Visszaigazol"
                                        style="color: green; border: 2px solid green; padding: 3px; border-radius: 50%; cursor: pointer; margin-right: 10px;">
                                        </i>
                                    {% endif %}

                                    <!-- Piros checkbox (Elutasítás) csak akkor, ha van értéke -->
                                    {% if response == 2 %}
                                        <i class="fas fa-times-circle rejectCrewAssignment"
                                        data-assignment='{"assignmentId": "{{ crew.crewAssignments_id }}", "userId": "{{ crew.users_userid }}", "projectId": "{{ crew.projects_id }}", "response": 2}'
                                        title="Elutasítva"
                                        style="color: red; cursor: pointer; margin-right: 10px;">
                                        </i>
                                    {% else %}
                                        <i class="far fa-circle rejectCrewAssignment"
                                        data-assignment='{"assignmentId": "{{ crew.crewAssignments_id }}", "userId": "{{ crew.users_userid }}", "projectId": "{{ crew.projects_id }}", "response": 2}'
                                        title="Elutasít"
                                        style="color: red; border: 2px solid red; padding: 3px; border-radius: 50%; cursor: pointer; margin-right: 10px;">
                                        </i>
                                    {% endif %}

                                {% else %}
                                    <!-- Csak a státusz megjelenítése, módosítás nélkül -->
                                    {% if response == 1 %}
                                        <i class="fas fa-check-circle"
                                        title="Elfogadva"
                                        style="color: green; margin-right: 10px;">
                                        </i>
                                    {% elseif response == 2 %}
                                        <i class="fas fa-times-circle"
                                        title="Elutasítva"
                                        style="color: red; margin-right: 10px;">
                                        </i>
                                    {% else %}
                                        <i class="far fa-circle"
                                        title="Nincs visszaigazolva"
                                        style="color: gray; border: 2px solid gray; padding: 3px; border-radius: 50%; margin-right: 10px;">
                                        </i>
                                    {% endif %}
                                {% endif %}

                                <script>
                                $(document).ready(function () {
                                    // Function to handle crew assignment updates
                                    function updateCrewAssignment(assignmentData) {
                                        ajaxcall("projects/crew/response.php", {
                                            assignmentId: assignmentData.assignmentId,
                                            response: assignmentData.response,
                                            userId: assignmentData.userId,
                                            projectId: assignmentData.projectId
                                        }, function (data) {
                                            if (data.success) {
                                                location.reload();
                                            } else {
                                                location.reload();
                                            }
                                        });
                                    }

                                    // Elfogadás (zöld pipa)
                                    $(".confirmCrewAssignment").click(function () {
                                        let assignmentData = $(this).data("assignment");
                                        updateCrewAssignment(assignmentData);
                                    });

                                    // Elutasítás (piros pipa)
                                    $(".rejectCrewAssignment").click(function () {
                                        let assignmentData = $(this).data("assignment");
                                        updateCrewAssignment(assignmentData);
                                    });
                                });
                                </script>

                                {% if "PROJECTS:PROJECT_CREW:EDIT"|instancePermissions %}
                                    <!-- Szerkesztés ikon -->
                                    <i class="far fa-edit editCrewAssignment"
                                    data-assignment="{{ crew.crewAssignments_id }}"
                                    data-role="{{ crew.crewAssignments_role|escape('html_attr') }}"
                                    data-comment="{{ crew.crewAssignments_comment|escape('html_attr') }}"
                                    title="Szerkesztés"
                                    style="margin-right: 5px;"></i>

                                    <!-- Komment szerkesztése ikon -->
                                    <i class="far fa-comment editCrewAssignmentComment"
                                    data-assignment="{{ crew.crewAssignments_id }}"
                                    data-comment="{{ crew.crewAssignments_comment|escape('html_attr') }}"
                                    title="Komment szerkesztése"
                                    style="margin-right: 5px;"></i>

                                    <!-- Törlés ikon -->
                                    <i class="fas fa-trash deleteCrewAssignment"
                                    data-assignment="{{ crew.crewAssignments_id }}"
                                    title="Stáb törlése"
                                    style="margin-right: 5px;"></i>
                                {% endif %}
                            </div>

                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title">Szabad Személyzet Pozíciók</h3>
                {% if "PROJECTS:PROJECT_CREW:EDIT:CREW_RECRUITMENT"|instancePermissions %}
                <a href="{{ CONFIG.ROOTURL }}/project/crew/vacantCrew.php?id={{ project.projects_id }}" type="button" class="btn btn-secondary btn-sm ml-auto">Kezelés</a>
                {% endif %}
            </div>
        </div>
        {% if crewRecruitment|length < 1 %}
            <div class="alert alert-info">
                <p class="my-auto">
                    <i class="fas fa-info-circle"></i> 
                    Jelenleg nincsenek szabad pozíciók ehhez a projekthez.
                </p>
            </div>
        {% endif %}
        {% for role in crewRecruitment %}
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">{{ role.projectsVacantRoles_name }}</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <h5>Leírás</h5>
                            <p>{{ role.projectsVacantRoles_description }}</p>
                            <h5>Elvárások</h5>
                            <p>{{ role.projectsVacantRoles_personSpecification }}</p>
                            {% if role.projectsVacantRoles_deadline %}
                                <p>
                                    <strong>Határidő: </strong>
                                    {{ role.projectsVacantRoles_deadline|date("d M Y h:ia") }}
                                </p>
                            {% endif %}
                            <p>
                                <strong>Helyek száma: </strong>
                                {{ role.projectsVacantRoles_slots - role.projectsVacantRoles_slotsFilled }}
                            </p>
                            <div class="project-actions text-center">
                                <div class="btn-group">
                                    <a type="button" class="btn btn-default btn-sm" href="{{CONFIG.ROOTURL}}/project/crew/vacancy.php?id={{ role.projectsVacantRoles_id }}&from=project">
                                        További információk és
                                        {% if role.projectsVacantRoles_firstComeFirstServed %}
                                        Jelentkezés
                                        {% else %}
                                        Pályázat
                                        {% endif %}
                                    </a>
                                </div>
                            </div>
                        </div>      
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>